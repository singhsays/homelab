version: "3"

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - services
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    environment:
      DO_AUTH_TOKEN: "cat /run/secrets/do-auth-token"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./services/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./services/traefik/config.yml:/config.yml:ro
      - cert-data-volume:/data
    secrets:
      - do-auth-token
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.entrypoints=http"
      - "traefik.http.routers.traefik.rule=Host(`traefik.home`)"
      - "traefik.http.middlewares.traefik-https-redirect.redirectsheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
      - "traefik.http.routers.traefik.middlewares=traefik-https-redirect"
      - "traefik.http.routers.traefik-tls.entrypoints=https"
      - "traefik.http.routers.traefik-tls.rule=Host(`traefik.home`)"
      - "traefik.http.routers.traefik-tls.tls=true"
      - "traefik.http.routers.traefik-tls.tls.certresolver=digitalocean"
      - "traefik.http.routers.traefik-tls.tls.domains[0].main=home.singhsays.com"
      - "traefik.http.routers.traefik-tls.tls.domains[0].sans=*.home.singhsays.com"
      - "traefik.http.routers.traefik-tls.service=api@internal"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    networks:
      - services
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data-volume:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.entrypoints=http"
      - "traefik.http.routers.portainer.rule=Host(`portainer.home`)"
      - "traefik.http.middlewares.portainer-https-redirect.redirectsheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.portainer.middlewares=portianer-https-redirect"
      - "traefik.http.routers.portainer-tls.entrypoints=https"
      - "traefik.http.routers.portainer-tls.rule=Host(`portainer.home`)"
      - "traefik.http.routers.portainer-tls.tls=true"
      - "traefik.http.routers.portainer-tls.tls.certresolver=digitalocean"
      - "traefik.http.routers.portainer-tls.tls.domains[0].main=home.singhsays.com"
      - "traefik.http.routers.portainer-tls.tls.domains[0].sans=*.home.singhsays.com"
      - "traefik.http.services.portainer.loadbalancer.server.scheme=https"
      - "traefik.http.services.portainer.loadbalancer.server.port=9443"
      - "traefik.docker.network=services"

networks:
  services:
    name: services
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
      com.docker.network.bridge.name: "services"

volumes:
  portainer-data-volume:
    name: portainer-data-volume
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr=10.0.0.10,rw"
      device: ":/volume1/docker/portainer-data-volume"
  cert-data-volume:
    name: cert-data-volume
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr=10.0.0.10,rw"
      device: ":/volume1/docker/cert-data-volume"

secrets:
  do-auth-token:
    file: ./secrets/do-auth-token.secret
